{% extends "base.html" %}

{% block title %}{{ track_name }} ({{ selected_cc }} {{ selected_items }}){% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ track_name }} ({{ track_abbrev }})</h1>
    <a href="{{ url_for('timesheet', cc=selected_cc, items=selected_items) }}">Back to Timesheet</a>

    <!-- Deletion alert and modal -->
    {% include "delete_time_modal.html" %}

    <!-- Filters form (change cc or items) -->
    <form method="GET" class="mb-3">
        <input type="hidden" name="track" value="{{ track_name }}">

        <label for="cc" class="form-label">Select CC:</label>
        <select name="cc" id="cc" class="form-select d-inline w-auto">
            {% for cc in cc_categories %}
                <option value="{{ cc }}" {% if cc == selected_cc %}selected{% endif %}>{{ cc }}</option>
            {% endfor %}
        </select>

        <label for="items" class="form-label">Select Item Type:</label>
        <select name="items" id="items" class="form-select d-inline w-auto">
            {% for item in item_options %}
                <option value="{{ item }}" {% if item == selected_items %}selected{% endif %}>{{ item }}</option>
            {% endfor %}
        </select>

        <button type="submit" class="btn btn-primary">Filter</button>
    </form>

    <div class="row">
        <div class="col-md-8">
            <canvas id="timeProgressChart"></canvas>
        </div>
        <div class="col-md-4">
            <!-- Add time form -->
            <!-- <form method="POST" action="url_for('insert_time', track=track_name, cc=selected_cc, items=selected_items) }}" class="row g-3">
                <div class="col-md-4">
                    <label for="time" class="form-label">New Time:</label>
                    <input type="text" name="time" id="time" class="form-control" placeholder="M:SS.sss" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-success mt-4">Add Time</button>
                </div>
            </form> -->
            <table class="table table-sm hover compact" id="timesTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Time</th>
                        <th>Impr</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in times %}
                    <tr>
                        <td>{{ times|length - row.Num + 1 }}</td>
                        <td>{{ row.Time }}</td>
                        <td>{% if row.Impr is not none %} -{{ row.Impr }} {% endif %}</td>
                        <td>
                            <button class="btn btn-danger delete-btn icon-link"
                                    data-bs-toggle="modal"
                                    data-bs-target="#confirmDeleteModal"
                                    data-id="{{ row.RowId }}"
                                    data-track="{{ track_name }}"
                                    data-time="{{ row.Time }}"
                                    data-cc="{{ selected_cc }}"
                                    data-items="{{ selected_items }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-lg" viewBox="0 0 16 16">
                                    <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script>
        const indices = {{ times | tojson | safe }}.map(t => t["Num"]);
        const timesStr = {{ times | tojson | safe }}.map(t => t["Time"]).reverse();
        const timesSec = {{ times | tojson | safe }}.map(t => t["TimeNum"]).reverse();
    </script>
    <script type="module" src="{{ url_for('static', filename='track.js') }}"></script>
    <script src="{{ url_for('static', filename='delete_time.js') }}"></script>
{% endblock %}
